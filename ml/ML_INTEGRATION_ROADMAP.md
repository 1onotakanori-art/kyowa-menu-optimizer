# 機械学習モデル統合ロードマップ

## 現在の状況 ✅

### 完了済み
- ✅ **Phase 1: データ収集** (2026-01-29)
  - kyowa-menu-historyから15日分のデータ取得
  - 606メニュー、49選択データを統合
  - training_data.jsonを作成

- ✅ **Phase 2: 機械学習モデル構築** (2026-01-29)
  - 栄養素ベース特徴量（PFC、エネルギー、野菜重量など）
  - テキストベース特徴量（メニュー名の単語抽出）
  - 共起パターン分析
  - RandomForestモデル（AUC-ROC 0.9995）
  - モデル保存: `ml/model/menu_recommender.pkl`

---

## Phase 3: 静的ファイル生成とGitHub Pages統合 ✅

### 目標
**サーバー不要**の静的ホスティング戦略。ローカルでAI推薦を生成し、JSONファイルとしてGitHubにアップロード

### タスク

#### 3-1. AI推薦生成スクリプト ✅
- ✅ `ml/generate_ai_selections.py` 作成
- ✅ 全メニューに対してAI推薦スコアを計算
- ✅ `docs/ai-selections/ai-selections_YYYY-MM-DD.json` に出力
- ✅ 各メニューにランク・スコア・推薦理由を付与
- ✅ `available-ai-dates.json` で利用可能日付一覧を管理

#### 3-2. データ構造
出力形式:
```json
{
  "date": "2026-01-13",
  "dateLabel": "1/13(火)",
  "selectedMenus": [
    {
      "name": "たんぱく質の摂れる小鉢 蒸し鶏＆ブロッコリー",
      "score": 0.760,
      "rank": 1,
      "reasons": ["野菜が多い", "共起パターンが強い"]
    }
  ],
  "allMenusWithScores": [...],
  "modelInfo": {...}
}
```

#### 3-3. 生成実績 ✅
- ✅ 17日分のAI推薦を生成
- ✅ GitHubにプッシュ完了
- ✅ GitHub Pagesで公開中

**完了日**: 2026-01-29

---

## Phase 4: フロントエンド統合 ✅

### 目標
GitHub PagesのWebアプリにAI推薦を表示

### タスク

#### 4-1. AI推薦データの読み込み ✅
- ✅ `app.js`に`loadAISelections(date)`関数追加
- ✅ `docs/ai-selections/ai-selections_YYYY-MM-DD.json`を読み込み
- ✅ メニュー表示時にAI推薦スコアをマージ
- ✅ `getAIRecommendation(menuName)`ヘルパー関数追加

#### 4-2. UIデザイン ✅
- ✅ 推薦メニューに⭐マーク表示（TOP3のみ）
- ✅ ツールチップでランク・スコア表示
- ✅ メニュー名の横に配置

#### 4-3. スタイリング ✅
- ✅ `.ai-recommendation-badge`スタイル追加
- ✅ レスポンシブ対応（flexboxレイアウト）

#### 4-4. デプロイ ✅
- ✅ GitHubにプッシュ
- ✅ GitHub Pagesで公開

**完了日**: 2026-01-29

---

## Phase 5: 継続学習システム 🔄

### 目標
日々の選択データを使ってモデルを自動更新

### タスク

#### 5-1. データ更新スクリプト
- [ ] `ml/update_training_data.js` - 新しい履歴データを自動取得
- [ ] GitHub Actions ワークフロー設定（毎日実行）

#### 5-2. 自動再学習スクリプト
- [ ] `ml/retrain_model.py` - データ更新後にモデルを自動再学習
- [ ] パフォーマンスログ記録（AUC-ROC推移など）
- [ ] モデルバージョン管理

#### 5-3. モデル配信
- [ ] 新しいモデルの自動デプロイ仕組み
- [ ] A/Bテスト機能（旧モデル vs 新モデル）

**完了予定**: 3-4日

---

## Phase 6: 高度な機能追加 ✨

### 目標
より洗練された推薦システム

### タスク

#### 6-1. コンテキスト考慮
- [ ] 曜日による推薦変更
- [ ] 季節・月による推薦変更
- [ ] 前日の選択履歴を考慮

#### 6-2. 栄養バランス最適化
- [ ] 既に選択したメニューとのバランスを考慮
- [ ] 目標栄養素達成に近づく推薦
- [ ] 制約条件（上限・下限）との整合性

#### 6-3. 説明可能性
- [ ] 「なぜこのメニューを推薦したか」の説明文生成
- [ ] 重要な特徴量の可視化

**完了予定**: 4-5日

---

## Phase 7: 評価とフィードバック 📊

### 目標
推薦精度を継続的に改善

### タスク

#### 7-1. メトリクス収集
- [ ] 推薦メニューの選択率トラッキング
- [ ] ユーザー満足度スコア
- [ ] 栄養目標達成率

#### 7-2. ダッシュボード
- [ ] 推薦システムの性能ダッシュボード
- [ ] 日次/週次レポート自動生成
- [ ] モデル性能の可視化

#### 7-3. フィードバックループ
- [ ] 「この推薦は良かった/悪かった」ボタン
- [ ] フィードバックデータを学習に反映

**完了予定**: 3-4日

---

## Phase 8: 本番運用とスケーリング 🚀

### 目標
安定稼働と将来の拡張に備える

### タスク

#### 8-1. パフォーマンス最適化
- [ ] モデル推論の高速化（キャッシング）
- [ ] APIレスポンスタイム最適化
- [ ] メモリ使用量削減

#### 8-2. モニタリング
- [ ] エラーログ収集
- [ ] アラート設定（モデル精度低下時など）
- [ ] ヘルスチェックエンドポイント

#### 8-3. ドキュメント整備
- [ ] API仕様書
- [ ] 運用マニュアル
- [ ] トラブルシューティングガイド

**完了予定**: 2-3日

---

## 総合スケジュール

| Phase | 内容 | 期間 | ステータス |
|-------|------|------|----------|
| Phase 1 | データ収集 | - | ✅ 完了 |
| Phase 2 | MLモデル構築 | - | ✅ 完了 |
| Phase 3 | API化 | 1-2日 | ⏳ 次 |
| Phase 4 | フロントエンド統合 | 2-3日 | - |
| Phase 5 | 継続学習 | 3-4日 | - |
| Phase 6 | 高度な機能 | 4-5日 | - |
| Phase 7 | 評価・FB | 3-4日 | - |
| Phase 8 | 本番運用 | 2-3日 | - |

**総工数見積もり**: 約15-24日

---

## 次のアクション

### すぐに始められるタスク

1. **Python API サーバー構築** (Phase 3-1)
   ```bash
   pip install fastapi uvicorn
   # ml/api_server.py を作成
   ```

2. **簡易テスト**
   ```bash
   # ローカルでAPIサーバー起動
   uvicorn api_server:app --reload
   
   # curlでテスト
   curl -X POST http://localhost:8000/api/ml/recommend \
     -H "Content-Type: application/json" \
     -d '{"menus": [...], "selected": [...]}'
   ```

3. **既存アプリとの統合ポイント確認**
   - `src/optimizer/optimizeMenus.js` - 最適化ロジックに推薦スコア統合
   - `app.js` - メニュー表示時に推薦マーク追加
   - `index.html` - AI推薦ボタン追加

---

## 技術スタック

### 機械学習側
- Python 3.9+
- scikit-learn (RandomForest)
- FastAPI / Flask (API)
- pickle (モデル永続化)

### アプリケーション側
- Node.js / Express
- JavaScript (フロントエンド)
- fetch API (Python APIとの通信)

### インフラ
- ローカル開発: localhost
- 本番想定: 同一サーバー内でポート分離
- 将来的にはDockerコンテナ化も検討

---

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Python API のレスポンス遅延 | 中 | キャッシング、非同期処理 |
| モデル精度の低下 | 中 | 定期評価、A/Bテスト |
| データ不足（初期） | 低 | 継続的なデータ収集 |
| 過学習 | 低 | クロスバリデーション実施済み |

---

## 参考資料

- [scikit-learn Documentation](https://scikit-learn.org/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [機械学習の実装パターン](https://ml-ops.org/)
