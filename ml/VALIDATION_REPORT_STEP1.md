# Step 1: 検証戦略の改善 - 診断レポート

**実行日**: 2026年2月1日  
**データ期間**: 2026-01-13 ~ 2026-02-13 (20日分)

---

## 📊 データ状況

| 項目 | 値 |
|------|-----|
| 学習データ日数 | 20日 |
| 総メニュー数 | 810個 |
| 総選択数 | 67個 |
| ユニークメニュー | 50個 |
| 平均選択率 | 8.3% |
| 1日あたりの選択数 | 3.4個 |

---

## 🎯 主要な発見

### 1. **データ量が不足している**
- ✅ **日数**: 20日は機械学習としては少ない
- ✅ **選択数**: 総67個は非常に限定的
- ✅ **スパース性**: 810個のメニューから平均3.4個のみ選択（91.7%が非選択）

### 2. **明確なメニュー嗜好が見られる**
**TOP 3メニュー**:
1. 🥇 「たんぱく質の摂れる小鉢 蒸し鶏＆ブロッコリー」 → 9回選択 (13.4%)
2. 🥈 「ライス（S）」 → 6回選択 (9.0%)
3. 🥉 「茶碗蒸し」 → 3回選択 (4.5%)

**重要**: 上位3メニューで全選択の26.9%を占める

### 3. **メニュー相互作用が弱い**
**最も共起するペア**:
- 「蒸し鶏＆ブロッコリー」 ↔ 「ライス（S）」: 3回
- その他のペアはすべて1回のみ

**⚠️ 問題点**: メニュー間の関係性が非常に希薄
- 同じペアが繰り返し選ばれていない
- セットの多様性が高い

### 4. **選択率が低い（8.3%）**
- 利用可能なメニューの大部分が選ばれない
- 分類問題として難しい（不均衡が大きい）

---

## ⚠️ 過学習リスク評価

### リスク度: **🔴 高**

**理由**:
1. **データスパース**: 810個メニューに対して67個サンプル
   - 特徴量数が多すぎる（メニュー名の単語特徴など）
   - サンプル数が少なすぎる

2. **クラス不均衡**: 選択(1) vs 非選択(0) = 67 : 743
   - 負例に対して正例が8.3%のみ

3. **ユニークメニューの多さ**: 50個のメニューが20日間で使い回される
   - 各メニューの出現回数: 平均1.34回
   - ほとんどのメニューが1-2日のみ登場

---

## 🔬 推奨検証方法

### Phase 1: 基本的な検証（推奨）

#### ✅ 1. 時系列分割検証
```python
train_data: 2026-01-13 ~ 2026-02-03 (16日)  # 64%
test_data:  2026-02-04 ~ 2026-02-13 (10日)  # 36%
```

**目的**: 未来データへの汎化性能を測定

**期待される結果**:
- 過学習している場合: train精度 > test精度 で大きな差
- 正常な場合: train精度 ≈ test精度 で差は小さい

#### ✅ 2. Leave-Future-Out 交差検証
```
Fold 1: Train[1-8日]    → Test[9-10日]
Fold 2: Train[1-10日]   → Test[11-12日]
Fold 3: Train[1-12日]   → Test[13-14日]
Fold 4: Train[1-14日]   → Test[15-16日]
Fold 5: Train[1-16日]   → Test[17-20日]
```

**目的**: 学習データが増えるにつれて性能がどう変化するか観察

**期待される結果**:
- 正常: 初期は性能低い → 段階的に改善
- 過学習: 早期に高精度 → 後期でプラトー or 低下

---

## 📈 評価指標

### 1. **個別メニュー精度** (Menu Accuracy)
```
定義: 正しく予測されたメニュー数 / 総メニュー数
```
- 親密度: 各メニューの選択/非選択を正しく予測できているか
- 課題: クラス不均衡の影響を受ける

### 2. **セット類似度** (Jaccard Similarity)
```
定義: |予測セット ∩ 実際のセット| / |予測セット ∪ 実際のセット|
範囲: 0 ~ 1 (1が完璧)
```
- 重要: ユーザーに提示するのは「セット」なので、このメトリクスが最重要
- 例: 予測[A,B,C] vs 実際[A,B,D] → Jaccard = 1/4 = 0.25

### 3. **栄養素RMSE** (Nutrition RMSE)
```
定義: √(∑(予測栄養値 - 実際)² / サンプル数)
```
- 重要: 栄養バランスの予測精度
- 単位: kcal, g など

### 4. **F1スコア** (均衡指標)
- クラス不均衡対策
- 精度と再現率の調和平均

---

## 🎯 診断結論

### 現在のモデル性能の見立て

**低い可能性が高い** 理由:
1. データが少ない (20日分)
2. 選択メニューが限定的 (67個)
3. メニュー相互作用が弱い
4. スパース性が高い

**予想される精度**:
- メニュー精度: 60-75% (クラス不均衡の影響)
- セット Jaccard: 20-40% (セット全体の一致は難しい)
- 栄養素 RMSE: 中程度 (基本的なトレンドは学習可能)

---

## 📋 次のステップ

### Step 2: 実装する検証スクリプト

**ファイル**: `validate_model.py`

**実行方法**:
```bash
python validate_model.py
```

**出力**:
- `validation_results.json` - 詳細な結果
- `validation_results.png` - グラフ

**所要時間**: 10-30分（モデル学習含む）

### Step 3: 結果に基づいた判断

**パターン A: 過学習が確認された場合**
```
→ Seq2Set Transformer の導入を推奨
→ メニュー相互作用を明示的にモデル化
→ 説明生成機能の追加
```

**パターン B: 汎化性能が十分な場合**
```
→ 現在のモデルを継続使用
→ より多くの学習データを収集
→ 微調整と最適化に注力
```

**パターン C: 性能が不安定な場合**
```
→ データの質の確認（選択ラベルの正確性）
→ 特徴量エンジニアリングの改善
→ より堅牢なモデルアーキテクチャの検討
```

---

## 💡 データ収集の推奨

より良いモデルのために:
- ✅ 最低でも 60-90日のデータを収集したい
- ✅ できれば 180日 (約6ヶ月) で季節変動を捉えたい
- ✅ ユーザーの嗜好が安定する観察期間が必要

---

**作成者**: AI Assistant  
**次回確認予定**: 検証スクリプト実行後
