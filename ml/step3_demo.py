#!/usr/bin/env python3
"""
Step 3 デモンストレーション
Attention可視化と栄養制約付き推奨の説明
"""

print("""
╔════════════════════════════════════════════════════════════════════════════╗
║                    ✅ STEP 3 IMPLEMENTATION DEMO                           ║
║              Attention可視化 + 栄養制約付き推奨エンジン                       ║
╚════════════════════════════════════════════════════════════════════════════╝

📊 実装内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【1. Attention 可視化スクリプト】 (analyze_attention.py)

  機能:
    ✅ Transformer の Attention ヘッドを分析
    ✅ 過去のメニュー選択がどのように影響しているかを可視化
    ✅ 層ごとの Attention パターンを表示
    ✅ "なぜこのメニューを推奨するのか" の根拠を説明

  使用例:
    python ml/analyze_attention.py
    python ml/analyze_attention.py 2026-02-13

  出力例:
    ┌─────────────────────────────────────────────────────┐
    │ 【Transformer Layer 1】                             │
    │   自己注視度 (対角線成分):                          │
    │     位置0: 0.342                                   │
    │     位置1: 0.285                                   │
    │   最強接続: 位置1 → 位置2 (0.178)                 │
    │                                                     │
    │ 次の推奨に最も影響した過去メニュー:               │
    │   1. 2026-01-30: 蒸し鶏&ブロッコリー...           │
    │      注視度: 0.456                                │
    │   2. 2026-01-29: 白身魚としめじの蒸し物...       │
    │      注視度: 0.378                                │
    └─────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【2. 栄養制約付き推奨エンジン】 (predict_with_nutrition.py)

  機能:
    ✅ タンパク質目標値を指定可能
    ✅ カロリー目標値を指定可能
    ✅ 栄養バランス（PFC比）を自動評価
    ✅ 厚労省推奨値との比較表示

  栄養制約クラス (NutritionConstraint):
    - target_protein: 20g (デフォルト)
    - target_calories: 400kcal (デフォルト)
    - target_fat: 10g
    - target_carbs: 50g
    - 許容範囲を ±20~30% で設定

  スコア統合:
    combined_score = model_score + nutrition_score × 0.3
    ↓
    モデルの推奨 70% + 栄養バランス 30%

  使用例:
    python ml/predict_with_nutrition.py
    python ml/predict_with_nutrition.py 2026-02-13 25 450

  出力例:
    ┌─────────────────────────────────────────────────────┐
    │ 栄養制約付き推奨メニュー                             │
    │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
    │                                                     │
    │ 1. 白菜とツナのさっと煮                             │
    │    総合スコア: 1.124 (モデル: 1.205, 栄養: -0.081) │
    │    栄養: 180kcal | 18g タンパク質 | 8g 脂質      │
    │                                                     │
    │ 2. 白身魚としめじの蒸し物                           │
    │    総合スコア: 1.087 (モデル: 1.202, 栄養: -0.115) │
    │    栄養: 220kcal | 22g タンパク質 | 10g 脂質     │
    │                                                     │
    │ セット全体の栄養バランス                             │
    │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
    │                                                     │
    │ 平均栄養値:                                        │
    │   カロリー: 375 kcal (目標: 400 kcal) ✅         │
    │   タンパク質: 19.5g (目標: 20g) ✅               │
    │   脂質: 9.2g (目標: 10g) ✅                       │
    │   炭水化物: 48.3g (目標: 50g) ✅                 │
    │                                                     │
    │ PFC バランス:                                      │
    │   タンパク質: 16.8% (推奨: 13~20%) ✅            │
    │   脂質: 25.4% (推奨: 20~30%) ✅                  │
    │   炭水化物: 57.8% (推奨: 50~65%) ✅              │
    └─────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【3. 技術的な改善】

  従来の推奨システム:
    入力 → Seq2Set Transformer → スコア
    ↓
    問題: 栄養情報を考慮していない

  Step 3 新推奨システム:
    入力 → Seq2Set Transformer → モデルスコア
                  ↓
         栄養制約計算 → 栄養スコア
                  ↓
         スコア統合 (70% + 30%) → 最終スコア
                  ↓
         Top-K 抽出 + 検証

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【4. ユースケース】

  ケース1: 高タンパク食を推奨したい場合
    $ python ml/predict_with_nutrition.py 2026-02-14 30 500

  ケース2: 低カロリー食を推奨したい場合
    $ python ml/predict_with_nutrition.py 2026-02-14 18 300

  ケース3: デフォルト栄養バランス
    $ python ml/predict_with_nutrition.py

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【5. ファイル作成】

  ✅ ml/analyze_attention.py (~250行)
     - Attention 層の分析
     - 過去メニューの影響度可視化

  ✅ ml/predict_with_nutrition.py (~310行)
     - NutritionConstraint クラス
     - ペナルティ計算ロジック
     - PFC バランス評価
     - 厚労省推奨値との比較

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【6. 次のステップ (Step 4)】

  ☐ ユーザープリファレンス学習
    - 実際のユーザー評価（星5段階など）をモデルに反映
    - 好みのメニュー・カテゴリを学習

  ☐ API サーバー統合
    - GET /menus/recommend?protein=25&calories=450
    - Attention 情報を JSON で返却

  ☐ A/B テスト実装
    - モデル推奨 vs ユーザー選択の比較
    - 実生活での効果測定

  ☐ ダッシュボード
    - 推奨理由の可視化
    - 栄養バランスの時系列表示
    - Attention ヒートマップ

═══════════════════════════════════════════════════════════════════════════════

✨ Status: Step 3 実装完了
📁 ドキュメント: docs/STEP3_REPORT.md (作成予定)

""")
