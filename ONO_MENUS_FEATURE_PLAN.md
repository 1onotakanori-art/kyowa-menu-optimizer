# ONO Menus機能実装計画

## プロジェクト概要

kyowa-menu-historyリポジトリに蓄積されたメニュー選択履歴を活用し、以下の2つの機能を実装する：

1. **履歴表示機能**: 実際に選択したメニューの公開
2. **AI学習機能**: 機械学習によるメニュー推薦システム

---

## フェーズ1: 履歴表示機能（ONO Menus）

### 目的
- 管理者（ONO）が実際に選択したメニューを一般ユーザーに公開
- 実際の選択例を提供することで、ユーザーの参考にする

### データソース
- **リポジトリ**: `kyowa-menu-history`
- **データ形式**: 日付ごとのメニュー選択履歴（JSON形式想定）
- **保存場所**: GitHubリポジトリまたはGitHub Pages

### UI設計

#### タブ追加
現在のタブ構成：
- メニュー
- 設定
- 結果

新しいタブ構成：
- メニュー
- 設定
- 結果
- **ONO Menus** ← 新規追加

#### ONO Menusタブの表示内容
1. **日付選択**
   - メニュータブと同じ日付セレクターを共有
   - 履歴データが存在する日付のみ選択可能（または「データなし」表示）

2. **選択メニュー表示**
   - メニューカード形式（現在の結果タブと同じスタイル）
   - メニュー名、画像、栄養成分を表示
   - 固定メニュー・提案メニューの区別なし（すべて選択済みとして表示）

3. **栄養成分サマリー**
   - EPFCVの合計値と件数
   - 達成率バー（設定タブの目標値と比較）
   - 栄養情報テーブル（目標・実績・差分・達成率）

### データ構造

#### 履歴データフォーマット（想定）
```json
{
  "date": "2026-01-22",
  "user": "ONO",
  "menus": [
    {
      "name": "豚肉の生姜焼き定食",
      "nutrition": {
        "エネルギー": 654,
        "たんぱく質": 28.5,
        "脂質": 24.2,
        "炭水化物": 75.3,
        "食塩相当量": 3.2,
        "野菜重量": 120
      }
    }
    // ...
  ],
  "totals": {
    "エネルギー": 1850,
    "たんぱく質": 75.2,
    // ...
  },
  "settings": {
    "targets": {
      "エネルギー": 2000,
      // ...
    }
  }
}
```

### 実装タスク

#### バックエンド
- [ ] kyowa-menu-historyリポジトリのデータ構造を確認
- [ ] 履歴データを取得するAPIエンドポイントの追加
  - `GET /history?date=YYYY-MM-DD`
  - `GET /history/available-dates` （履歴が存在する日付一覧）
- [ ] データの整形・バリデーション処理

#### フロントエンド
- [ ] ONO Menusタブの追加（HTML）
- [ ] タブ切り替えロジックの拡張（app.js）
- [ ] 履歴データ取得処理の実装
- [ ] メニュー表示コンポーネントの再利用
- [ ] 栄養成分サマリーの表示
- [ ] 日付選択時の履歴データ読み込み

#### スタイリング
- [ ] ONO Menusタブのスタイル（既存の結果タブと統一）
- [ ] データなし時の表示デザイン
- [ ] ローディング表示

---

## フェーズ2: AI学習機能（ONOAI推薦）

### 目的
- 蓄積された履歴データから学習し、最適なメニュー組み合わせを推薦
- 栄養バランスと個人の嗜好を考慮した推薦システム

### 学習環境の構築

#### 必要なツール・ライブラリ
```
Python環境:
- Python 3.10+
- pandas: データ処理
- numpy: 数値計算
- scikit-learn: 基本的な機械学習
- TensorFlow / PyTorch: ディープラーニング（必要に応じて）
- jupyter: 実験・分析環境
```

#### ディレクトリ構造（想定）
```
kyowa-menu-optimizer/
├── ml/                    # 機械学習関連
│   ├── data/             # 学習データ
│   │   ├── raw/         # 生データ（履歴）
│   │   ├── processed/   # 前処理済みデータ
│   │   └── features/    # 特徴量
│   ├── models/          # 学習済みモデル
│   ├── notebooks/       # Jupyter Notebook
│   ├── scripts/         # 学習スクリプト
│   │   ├── preprocess.py
│   │   ├── train.py
│   │   └── predict.py
│   └── requirements.txt
└── src/
    └── ml-api/          # 推論APIサーバー
        └── predict.js
```

### 学習アプローチ

#### データ準備
1. **履歴データの収集**
   - kyowa-menu-historyから過去の選択データを取得
   - メニュー情報、栄養成分、日付、曜日などを統合

2. **特徴量エンジニアリング**
   - メニューの栄養成分（EPFCV）
   - 曜日情報（平日/休日パターン）
   - 季節情報（月）
   - 過去の選択頻度
   - 栄養バランススコア（目標値との差分）

3. **ラベル作成**
   - 選択されたメニュー: 1
   - 選択されなかったメニュー: 0
   - または、複数メニューの組み合わせスコア

#### 学習モデル候補

**アプローチ1: 推薦システム（Collaborative Filtering）**
- メニュー間の類似度を学習
- コンテンツベースフィルタリング（栄養成分ベース）
- 実装: scikit-learn, surprise

**アプローチ2: 組み合わせ最適化（強化学習）**
- 状態: 現在の栄養合計値、残りの選択可能枠
- 行動: 次に選ぶメニュー
- 報酬: 栄養目標との近さ、過去の選択パターンとの一致度
- 実装: TensorFlow Agents, PyTorch

**アプローチ3: 分類モデル（シンプル）**
- 各メニューの選択確率を予測
- 上位N件を推薦として提示
- 実装: scikit-learn (RandomForest, XGBoost)

**推奨: まずはアプローチ3から開始**
- シンプルで実装が容易
- 結果の解釈が可能
- 段階的に高度なモデルに移行可能

### 推論フロー

#### バックエンド
1. フロントエンドから推薦リクエスト
   - `POST /ml/recommend`
   - Body: `{ date: "2026-01-22", targets: {...}, fixedMenus: [...] }`

2. Pythonスクリプトを呼び出し
   - Node.jsから`python predict.py`を実行
   - または、Flask/FastAPIで推論サーバーを別途起動

3. 推薦結果を返す
   - 推薦メニューリスト + 栄養成分合計
   - 信頼度スコア

#### フロントエンド（ONO Menusタブ）
1. **表示切り替え**
   - 「履歴」タブ: 実際の選択メニュー
   - 「ONOAI」タブ: AI推薦メニュー

2. **ONOAI表示内容**
   - 推薦メニューカード
   - 栄養成分サマリー
   - 信頼度スコア表示
   - 「この推薦を採用」ボタン（メニュータブに反映）

### 実装タスク

#### Phase 2.1: 環境構築
- [ ] Python環境のセットアップ
- [ ] 必要なライブラリのインストール
- [ ] Jupyter Notebook環境の構築
- [ ] データ収集スクリプトの作成

#### Phase 2.2: データ分析
- [ ] 履歴データの統計分析
- [ ] 選択パターンの可視化
- [ ] 栄養バランスの分析
- [ ] 特徴量の検討

#### Phase 2.3: モデル開発
- [ ] ベースラインモデルの作成（ランダム選択）
- [ ] シンプルな分類モデルの実装
- [ ] 交差検証による評価
- [ ] ハイパーパラメータチューニング
- [ ] モデルの保存・バージョン管理

#### Phase 2.4: 推論API実装
- [ ] Pythonスクリプトでの推論実装
- [ ] Node.jsからの呼び出し処理
- [ ] APIエンドポイントの追加
- [ ] エラーハンドリング

#### Phase 2.5: UI統合
- [ ] ONO Menusタブ内にサブタブ追加（履歴/ONOAI）
- [ ] ONOAI推薦の表示
- [ ] 信頼度スコアの可視化
- [ ] メニュータブへの反映機能

---

## 技術スタック

### 既存
- **フロントエンド**: Vanilla JavaScript, HTML, CSS
- **バックエンド**: Node.js, Express
- **スクレイピング**: Playwright
- **ホスティング**: GitHub Pages (静的), Render (API)

### 追加予定
- **機械学習**: Python 3.10+
  - pandas, numpy, scikit-learn
  - （オプション）TensorFlow/PyTorch
- **推論API**: Python (Flask/FastAPI) または Node.jsから直接呼び出し
- **データストレージ**: GitHub (kyowa-menu-history)

---

## スケジュール（想定）

### Week 1-2: Phase 1 - 履歴表示機能
- データ構造の設計
- APIエンドポイントの実装
- ONO Menusタブの実装
- テスト・デバッグ

### Week 3: Phase 2.1-2.2 - 環境構築・データ分析
- Python環境のセットアップ
- 履歴データの分析
- 特徴量設計

### Week 4-5: Phase 2.3-2.4 - モデル開発・API実装
- モデルの学習
- 推論APIの実装
- 性能評価

### Week 6: Phase 2.5 - UI統合
- ONOAI推薦の表示
- 統合テスト
- デプロイ

---

## リスク・課題

### データ量
- **課題**: 初期段階では履歴データが少ない可能性
- **対策**: 
  - シンプルなルールベースから開始
  - データが蓄積されたら機械学習モデルに移行
  - 栄養成分の類似度ベースの推薦を併用

### 推論速度
- **課題**: リアルタイム推薦が遅い可能性
- **対策**:
  - モデルの軽量化
  - 事前計算・キャッシング
  - バックグラウンド処理

### モデルの精度
- **課題**: 推薦が的外れになる可能性
- **対策**:
  - ユーザーフィードバック機能の追加
  - A/Bテスト
  - 継続的な学習・改善

### デプロイ
- **課題**: Python環境のホスティング
- **対策**:
  - Render/Heroku等でPython対応サーバーを使用
  - または、事前学習してモデルをJavaScriptで実行（TensorFlow.js）

---

## 次のステップ

### 即座に着手すべきタスク
1. ✅ この計画書の作成
2. kyowa-menu-historyリポジトリのデータ構造確認
3. 履歴データ取得APIの設計・実装
4. ONO Menusタブの基本実装（履歴表示）

### 並行して検討すべきこと
- Python環境のセットアップ方法
- 学習データの前処理方法
- モデルの評価指標（精度、適合率、栄養バランススコアなど）
- ユーザーフィードバックの収集方法

---

## 参考資料

### 関連リポジトリ
- `kyowa-menu-optimizer`: メインアプリケーション
- `kyowa-menu-history`: メニュー選択履歴

### 学習リソース
- 推薦システム: https://developers.google.com/machine-learning/recommendation
- scikit-learn: https://scikit-learn.org/
- 強化学習: https://www.tensorflow.org/agents

### デプロイ先候補
- Render: https://render.com/ (Python対応)
- Heroku: https://heroku.com/ (Python対応)
- AWS Lambda: サーバーレス推論
