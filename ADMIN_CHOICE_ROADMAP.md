# 管理者チョイス機能 実装ロードマップ

## 📋 概要

既存の最適化機能に加えて、**管理者の食事履歴から学習してメニューを推薦する機能**を追加します。

### コアコンセプト
- **データ駆動**: 管理者が実際に食べたメニューから好みや傾向を学習
- **自動化**: MacBook上で定期的に学習モデルを更新
- **公開**: 学習結果（管理者チョイス）を一般ユーザーにも表示

---

## 🎯 機能要件

### 1. 管理者用ページ（GitHub Pages）
**目的**: 毎日の食事記録を簡単に登録できる専用UI

#### 機能詳細
- **日付選択**: カレンダーUIで日付を選択
- **メニュー選択**: その日のメニューから食べたものをチェック
- **アップロード**: 選択結果をGitHubリポジトリにコミット
- **履歴表示**: 過去の食事記録を閲覧・編集

#### データ形式
```json
{
  "date": "2026-01-20",
  "eaten": ["肉豆腐", "ご飯（大）", "味噌汁"],
  "available": ["肉豆腐", "ご飯（大）", "味噌汁", "唐揚げ", ...],
  "nutrition": {
    "total": { "エネルギー": 850, "たんぱく質": 35, ... }
  }
}
```

#### 保存先
- `data/admin-history/history_YYYY-MM-DD.json`
- Git操作はGitHub API経由（Personal Access Token使用）

---

### 2. 学習パイプライン（MacBook ローカル）

**目的**: 食事履歴から管理者の好みを学習し、推薦メニューを生成

#### Phase 1: 基本学習（栄養バランス特徴量）

##### 学習内容
1. **栄養バランス傾向**
   - カロリー分布（平均、分散、好む範囲）
   - PFCバランス（たんぱく質:脂質:炭水化物の比率）
   - 各栄養素の絶対値傾向
   - 野菜重量の好み

2. **時系列パターン**
   - 曜日による傾向（週初め/週末での違い）
   - 季節性（もしデータが蓄積されたら）

##### 手法
- **統計的アプローチ**: 平均・分散・パーセンタイル
- **スコアリング**: 各メニューが過去の傾向にどれだけ近いか

##### 出力
```json
{
  "date": "2026-01-21",
  "recommendations": [
    {
      "name": "肉豆腐",
      "score": 0.85,
      "reason": "栄養バランスが好みに近い"
    },
    ...
  ],
  "stats": {
    "avg_energy": 850,
    "preferred_protein_ratio": 0.25,
    ...
  }
}
```

#### Phase 2: 発展学習（タグベース協調フィルタリング）

##### タグ付けシステム
- **自動タグ生成**: メニュー名から特徴を抽出
  ```javascript
  {
    "肉豆腐": ["肉", "豆腐", "煮物", "タンパク質豊富"],
    "唐揚げ": ["鶏肉", "揚げ物", "ボリューム"],
    "サラダ": ["野菜", "軽め", "ヘルシー"]
  }
  ```

- **タグ辞書**: `data/tags/menu-tags.json`

##### 学習内容
1. **タグ頻度分析**
   - よく食べられるタグ（例: "煮物" 70%、"揚げ物" 30%）
   - 避けられるタグ（例: "激辛" 5%）

2. **共起分析**
   - 一緒に食べられるタグの組み合わせ
   - 例: ["肉", "野菜", "ご飯"] の組み合わせ頻度が高い

3. **食べられなかったメニューの学習**
   - `available` だが `eaten` に含まれないメニューを「選ばれなかった」として記録
   - ネガティブフィードバックとして活用

##### 手法
- **協調フィルタリング**: 類似タグを持つメニューのスコアを伝播
- **アソシエーションルール**: Aprioriアルゴリズムでタグの共起ルールを抽出

##### 出力
```json
{
  "tag_preferences": {
    "肉": 0.75,
    "野菜": 0.90,
    "揚げ物": 0.35
  },
  "association_rules": [
    { "from": ["肉", "ご飯"], "to": "野菜", "confidence": 0.80 }
  ]
}
```

#### 実装構成
```
src/learning/
  ├── trainer.js           # メイン学習スクリプト
  ├── nutritionAnalyzer.js # 栄養バランス分析
  ├── tagExtractor.js      # タグ自動抽出
  ├── recommender.js       # スコア計算・推薦生成
  └── utils.js             # データ読込・保存
```

#### スケジュール実行
- `scheduler.js` に追加
- 毎日深夜に実行（週次スクレイピングの直後）
- 最新の食事履歴を取得 → 学習 → 推薦結果をコミット

---

### 3. 一般公開ページでの表示

**目的**: 学習結果を可視化し、ユーザーが「管理者チョイス」を参考にできる

#### UI設計

##### 新タブ: 「🎯 管理者チョイス」
- 既存の「設定」「メニュー」「結果」に加えて4つ目のタブ

##### 表示内容
1. **推薦メニュー一覧**
   - スコア順にソート
   - 各メニューに推薦理由を表示
   - 例: "よく選ばれる組み合わせ: 肉 + 野菜"

2. **管理者の傾向サマリー**
   - 好みの栄養バランス（円グラフ）
   - よく食べるタグTOP5
   - 平均カロリー・PFC比率

3. **比較機能**
   - 「最適化」タブの結果と「管理者チョイス」を並べて表示
   - 違いを可視化

#### データ取得
- `data/recommendations/recommendation_YYYY-MM-DD.json` から読込
- 日付セレクタで過去の推薦も閲覧可能

---

## 🗓️ 実装ロードマップ

### Phase 1: 基盤構築（Week 1-2）
**目標**: データ収集と基本学習の土台を作る

#### Step 1.1: 管理者用ページ（基本版）
- [ ] HTMLページ作成（`admin.html`）
- [ ] 日付選択UI
- [ ] メニュー選択UI（チェックボックス）
- [ ] GitHub API連携（Personal Access Token）
- [ ] JSONファイル保存機能
- [ ] 認証（簡易的なパスワード保護）

**成果物**: 
- `admin.html`
- `admin.js`
- `data/admin-history/` ディレクトリ

#### Step 1.2: データ収集期間
- [ ] 1週間分の食事データを手動で入力（テストデータ）
- [ ] データ形式の検証
- [ ] エラーハンドリングの確認

---

### Phase 2: 基本学習（Week 3-4）
**目標**: 栄養バランス学習と推薦生成

#### Step 2.1: 学習パイプライン構築
- [ ] `src/learning/trainer.js` 作成
- [ ] `src/learning/nutritionAnalyzer.js` 作成
  - 平均・分散計算
  - パーセンタイル分析
- [ ] `src/learning/recommender.js` 作成
  - スコアリングロジック
  - 推薦メニュー生成

#### Step 2.2: スケジュール化
- [ ] `scheduler.js` に学習タスク追加
- [ ] 毎日深夜に自動実行
- [ ] GitHub自動コミット

#### Step 2.3: 一般公開ページ統合
- [ ] 「管理者チョイス」タブ追加
- [ ] 推薦メニュー表示
- [ ] 基本的な統計情報表示

**成果物**:
- `src/learning/` モジュール
- `data/recommendations/` ディレクトリ
- 更新された `index.html`

---

### Phase 3: タグベース学習（Week 5-6）
**目標**: 高度な推薦システム

#### Step 3.1: タグ付けシステム
- [ ] `src/learning/tagExtractor.js` 作成
- [ ] メニュー名から特徴抽出
- [ ] タグ辞書作成（手動 + 自動）
- [ ] タグ頻度分析

#### Step 3.2: 協調フィルタリング
- [ ] タグベースのスコアリング
- [ ] 共起分析（Apriori実装）
- [ ] ネガティブフィードバック統合

#### Step 3.3: UI強化
- [ ] 推薦理由の詳細表示
- [ ] タグベースのフィルタリング
- [ ] 「最適化」vs「管理者チョイス」比較UI

**成果物**:
- タグ辞書 `data/tags/menu-tags.json`
- 更新された推薦ロジック
- 強化されたUI

---

### Phase 4: 精度向上と運用（Week 7+）
**目標**: 継続的改善とメンテナンス

#### Step 4.1: モデル評価
- [ ] 精度指標の定義（例: Top-5的中率）
- [ ] A/Bテスト準備
- [ ] ログ収集

#### Step 4.2: 長期運用
- [ ] データバックアップ
- [ ] エラー監視
- [ ] モデル再訓練の閾値設定

#### Step 4.3: 追加機能（Optional）
- [ ] 季節性学習
- [ ] 曜日別推薦
- [ ] 「今日の気分」フィルタ

---

## 🛠️ 技術スタック

### フロントエンド
- **既存**: Vanilla JS + HTML/CSS
- **新規**: Chart.js（統計可視化強化）

### バックエンド（ローカル）
- **Node.js**: 学習スクリプト
- **ライブラリ**:
  - `simple-statistics`: 統計計算
  - `natural`: NLP（タグ抽出）
  - `mljs`: 機械学習ユーティリティ（Optional）

### データ管理
- **GitHub**: データストレージ + バージョン管理
- **GitHub API**: ファイルアップロード
- **GitHub Actions**: （将来的に）学習の自動化

---

## 🔐 セキュリティ考慮事項

### 管理者用ページの保護
1. **基本認証**（Phase 1）
   - 簡易パスワード（環境変数）
   - GitHub Pages の制約上、完全な保護は困難

2. **GitHub Token管理**
   - Personal Access Tokenは環境変数で管理
   - スコープを最小限に（`repo` のみ）

3. **公開範囲**
   - 食事履歴は `data/admin-history/` に配置
   - `.gitignore` で除外するか、別リポジトリに分離

### 代替案: プライベートリポジトリ分離
- 食事履歴と学習モデルを別のプライベートリポジトリに保存
- 推薦結果のみをパブリックリポジトリにコピー

---

## 📊 データフロー図

```
┌─────────────────┐
│ 管理者用ページ  │
│ (admin.html)    │
└────────┬────────┘
         │ 食事記録入力
         ↓
┌─────────────────────────┐
│ GitHub Repository       │
│ data/admin-history/     │
│   history_YYYY-MM-DD.json│
└────────┬────────────────┘
         │
         ↓ (毎日深夜)
┌─────────────────┐
│ MacBook ローカル│
│ src/learning/   │
│   trainer.js    │
└────────┬────────┘
         │ 学習・推薦生成
         ↓
┌──────────────────────────┐
│ GitHub Repository        │
│ data/recommendations/    │
│   recommendation_YYYY-MM-DD.json │
└────────┬─────────────────┘
         │
         ↓ (ユーザーアクセス)
┌─────────────────┐
│ 一般公開ページ  │
│ index.html      │
│ (管理者チョイスタブ) │
└─────────────────┘
```

---

## 🚀 次のアクション

### すぐに始められること
1. **Phase 1.1: 管理者用ページのプロトタイプ作成**
   - `admin.html` の骨組み
   - ローカルで動作確認

2. **データ構造の確定**
   - `history_YYYY-MM-DD.json` のスキーマ定義
   - サンプルデータ作成

3. **GitHub API連携のテスト**
   - Personal Access Token取得
   - 簡単なファイルアップロードテスト

### 質問・検討事項
1. **管理者用ページの公開範囲**
   - GitHub Pages上で公開するか、完全にローカルで運用するか
   - 認証方式（簡易 vs しっかり）

2. **学習頻度**
   - 毎日実行 vs 週1回
   - リアルタイム性 vs 計算コスト

3. **タグ辞書の作成方法**
   - 最初は手動で作成するか
   - LLM（ChatGPT API等）を使って自動生成するか

4. **プライバシー**
   - 食事履歴を公開リポジトリに置くか
   - プライベートリポジトリに分離するか

---

## 📝 メモ・今後の拡張

### 将来的なアイデア
- **栄養士監修モード**: 栄養目標に対する達成度を可視化
- **SNS連携**: Twitterで毎日の推薦を自動ツイート
- **コミュニティ機能**: 複数ユーザーの好みを学習（プライバシー要配慮）
- **モバイルアプリ**: PWA化で管理者用ページをアプリ化

### 技術的課題
- **コールドスタート問題**: 初期データが少ない時の推薦精度
  - 最初は「人気メニュー」をフォールバックとして使用
- **データ不均衡**: 偏ったデータでの学習
  - スムージング処理やレギュラー化
- **計算量**: 履歴が増えた時の処理速度
  - キャッシング、インクリメンタル学習

---

**作成日**: 2026-01-20  
**最終更新**: 2026-01-20  
**ステータス**: Draft（フィードバック待ち）
