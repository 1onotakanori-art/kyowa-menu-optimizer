# UI改善記録 & TODO

最終更新: 2026年1月14日

## 📝 ファイル管理について

このファイルは **UI/UX 改善の進捗を記録** するための公式ドキュメントです。

### 🔄 毎回の修正ルール
- UI/UX 修正を実施した際は、**必ずこのファイルに追記** してください
- セクション `## 🔧 追加修正（YYYY/MM/DD）` を新規作成して記入
- 完了した修正は詳細を記録し、履歴として保持
- 未解決の問題や質問待ちの項目は `## ❓ 確認待ち項目` に記載

このアプローチにより、以下のメリットが生まれます：
- UI 改善の進捗が可視化される
- 実装内容が明確に残る
- 将来の機能追加時にリグレッション防止
- チーム間でのコミュニケーション効率向上

---

## ✅ 完了した修正（2026/01/14）

### 1. iPhone ブラウザの拡大防止
- **問題**: 数値入力時に画面が拡大され、全体が見づらくなる
- **解決**: `viewport` の `user-scalable=no`, `maximum-scale=1.0` を設定
- **ファイル**: `index.html`
- **影響**: 入力時の拡大が無効化され、スムーズな操作が可能に

### 2. メニュー表示数の制限解除
- **問題**: メニューが10個しか表示されない
- **原因**: `selectMenusByGreedy` の引数が固定で `10` になっていた
- **解決**: `availableMenus.length` に変更し、全メニューを対象に
- **ファイル**: `app.js`
- **影響**: 全メニューが最適化の候補として表示される

### 3. 野菜重量の略称変更
- **変更**: `VW` → `V`
- **ファイル**: `app.js`
- **影響**: メニュー表示が簡潔に

### 4. 栄養目標の UI 大幅改善
#### 4-1. 英語表記への変更
- エネルギー → **E**nergy
- たんぱく質 → **P**rotein
- 脂質 → **F**at
- 炭水化物 → **C**arbohydrate
- 野菜重量 → **V**egetable Weight

#### 4-2. レイアウト変更（横並び → 縦並び）
- グリッドレイアウトを `grid-template-columns: 1fr` に変更
- 各項目が1行で表示される（項目名、単位、入力欄が横一列）

#### 4-3. 頭文字の強調表示
- 各栄養項目の頭文字を `.nutrition-label` で色付け（青系統）
- メニュー表示の P, F, C, V と対応する色にする予定

#### 4-4. タップ選択化
- チェックボックス廃止
- 枠全体をタップで選択/解除
- 選択時は枠が青くなり、入力フィールドが表示される
- 未選択時は数値が非表示（プレースホルダーも非表示）

**ファイル**: `index.html`, `style.css`, `app.js`

### 5. メニュー表示の表形式化
#### 5-1. ボタン廃止・枠色判別に変更
- ⭕️/➕/❌ ボタンを削除
- 枠の左側の色で状態を判別
  - **緑枠**: 推奨（デフォルト）= 最適化の選択肢に含める
  - **青枠**: 固定 = 必ず含める
  - **赤枠**: 除外 = 含めない
- タップで状態を循環的に切り替え（推奨 → 固定 → 除外 → 推奨）

#### 5-2. 栄養成分の背景色設定
- **P（たんぱく質）**: 赤系統 (`#e74c3c`)
- **F（脂質）**: 黄色系統 (`#f39c12`)
- **C（炭水化物）**: 青系統 (`#3498db`)
- **V（野菜重量）**: 緑系統 (`#27ae60`)

#### 5-3. メニュー情報の表示順
1. メニュー名（太字）
2. 価格（円表記）
3. 栄養成分（P, F, C, V が横一列、背景色付き）

**ファイル**: `app.js`, `style.css`

### 6. ボタン説明（凡例）の追加
- メニュー選択セクションの上部に凡例を表示
- ⭕️ 固定（必ず含める）
- ➕ 推奨
- ❌ 除外
- 青系統の背景色で見やすく

**ファイル**: `index.html`, `style.css`

### 7. 最適化ボタンの配置変更
- メニュー選択の**上**に移動
- 理由: 何も選択せずに最適化する可能性があるため、アクセスしやすい位置に

**ファイル**: `index.html`

### 8. 最適化後の自動タブ切り替え
- 最適化実行後、自動で「結果」タブに切り替わる
- タブ切り替えの混乱を防ぐ

**ファイル**: `app.js`

### 9. 結果表示のメニュー形式統一
- 設定画面と同じ表形式を採用
- 固定メニュー = 青枠
- 提案メニュー = 緑枠
- 除外ボタン（✕）は右側に表示

**ファイル**: `app.js`, `style.css`

---

## 🔧 追加修正（2026/01/14 第3弾）

### 14. 栄養成分色をオプション B（明色背景＋黒文字）に変更 ✅
- **選択**: オプション B：明度を上げて黒文字表記
- **色設定**:
  - **E**: グレー背景 (`#d5dbdb`) + 黒文字
  - **P**: 明るい赤背景 (`#fadbd8`) + 黒文字
  - **F**: 明るい黄色背景 (`#fef5e7`) + 黒文字
  - **C**: 明るい青背景 (`#d6eaf8`) + 黒文字
  - **V**: 明るい緑背景 (`#d5f4e6`) + 黒文字
- **対象ファイル**: `style.css`
- **効果**: アクセシビリティ向上、視認性改善
- **コミット**: 218bd9b (2026/01/14)

### 15. PFC の数値が小数点なしになっていた問題を修正 ✅
- **問題**: `value.toFixed(1)` で小数点ありに設定していたが、反映されていなかった
- **原因**: 後の修正で `value.toFixed(0)` に誤って変更されていた
- **解決**: JSON データから読み込んだ値をそのまま表示（小数点あり）
- **ファイル**: `app.js`
- **コミット**: 218bd9b (2026/01/14)

### 16. メニュータップによる色変更バグの修正 ✅
- **問題**: 2回目以降のタップで色がおかしくなる
- **原因**: CSS の `.suggested` クラスを使用していたが、app.js で設定していなかった
  - 1回目のタップ：`fixed` または `excluded` クラスが正しく追加される
  - 2回目のタップ：戻るときに `.fixed` と `.excluded` が削除されるが、`.suggested` クラスが存在しないため、スタイルが不完全
- **解決**: デフォルト状態では特別なクラスを追加しない（`menu-list-item` の默认スタイルが推奨状態）
- **ファイル**: `app.js`
- **検証**: タップで `推奨（緑）→ 固定（青）→ 除外（赤）→ 推奨（緑）` に正しく切り替わる
- **コミット**: 218bd9b (2026/01/14)

### 17. 結果タブのメニュー表示に E を追加 ✅
- **変更**: 結果画面のメニュー栄養表示を P, F, C, V から E, P, F, C, V に変更
- **対象ファイル**: `app.js`
- **理由**: 設定画面との統一、エネルギー情報の視認性向上
- **コミット**: 218bd9b (2026/01/14)

### 18. 結果タブの❌ボタン位置をメニュー名の右に移動 ✅
- **問題**: ❌ボタンがメニュー栄養表示の右に配置されていた
- **解決**: 新規レイアウト `menu-result-header` を作成
  - メニュー名 | ❌ボタン（右端）
  - メニュー詳細情報はヘッダー下に配置
- **ファイル**: `app.js`, `style.css`
- **コミット**: 218bd9b (2026/01/14)

### 19. メニュー選択凡例の大幅改善 ✅
- **変更内容**:
  1. 栄養成分凡例：E, P, F, C, V を色付きボックスで表示
  2. メニュー状態凡例：推奨（緑）、固定（青）、除外（赤）を色で表示
  3. メニュー表示例凡例：実際のメニュー表示形式を例示
     - メニュー名
     - E, P, F, C, V の数値例を色付きボックスで表示
- **削除**: 古い「(PP,FF,CC,VV)」の意味不明な表記
- **対象ファイル**: `index.html`, `style.css`
- **効果**: ユーザーが一目でメニュー表示形式を理解できるように改善
- **コミット**: 218bd9b (2026/01/14)

### 20. 凡例の栄養ラベル文字色を修正 ✅
- **問題**: `.legend-item` に `color: white` が設定されていたため、明色背景の栄養ラベルで文字が見えなくなっていた
- **解決**: `.legend-item` から `color: white` を削除し、各栄養ラベルの `color: #000` が適用されるように修正
- **対象ファイル**: `style.css`
- **コミット**: d972368 (2026/01/14)

### 21. displayMenuGrid での .suggested クラス削除 ✅
- **問題**: 結果画面で `.suggested` クラスを追加していたが、デフォルトスタイルと二重定義になっていた
- **解決**: 提案メニュー（追加メニュー）ではクラスを追加せず、デフォルトの推奨スタイルを適用
- **対象ファイル**: `app.js`
- **コミット**: d972368 (2026/01/14)

### 22. メニュー栄養表示の等間隔化改善 ✅
- **問題**: E, P, F, C, V の栄養値ボックスが等間隔になっていない（長い数字で折り返し発生）
- **解決**: 
  - `word-break: break-all` を削除
  - `overflow: hidden`, `text-overflow: ellipsis`, `white-space: nowrap` を追加
  - グリッド5列（`repeat(5, 1fr)`）で厳密に等間隔化
- **対象ファイル**: `style.css`
- **コミット**: d972368 (2026/01/14)

### 23. 結果画面の栄養表示をグリッドレイアウトに統一 ✅
- **問題**: 結果画面のメニュー栄養表示が flex レイアウトで、設定画面と異なっていた
- **解決**: 結果画面も grid レイアウト（5列等間隔）に統一
- **対象ファイル**: `style.css`
- **効果**: 設定画面と結果画面で一貫した表示、視認性向上
- **コミット**: d972368 (2026/01/14)

## 🔧 追加修正（2026/01/14 第4弾）

### 24. マウスオーバー時の色変更を削除 ✅
- **問題**: iPhoneのタップ操作では、タップ後にマウスオーバー時の色が残って、タップ操作による色の正常な遷移が見えない
- **原因**: `.menu-list-item:hover` の設定により、タップ後にホバー色が残る
- **解決**: `.menu-list-item:hover` スタイルを削除（iPhone使用前提）
- **対象ファイル**: `style.css`
- **効果**: iPhoneでの色状態切り替えが正常に表示される

### 25. 凡例の栄養値にラベルを追加 ✅
- **変更内容**:
  - メニュー例の栄養値に「E 123.4」「P 12.5」のようにラベルを追加
  - 「栄養成分」セクションタイトルを削除（ラベルで明確化）
  - 凡例を2セクション構成に簡潔化：メニュー状態、メニュー例
- **対象ファイル**: `index.html`, `style.css`
- **効果**: ユーザーが栄養値の意味をすぐに理解できるように改善

### 26. 最大メニュー数の入力欄を追加 ✅
- **追加位置**: 日付選択の下（メインの設定項目に並ぶ）
- **機能**:
  - ユーザーが最大メニュー数を指定可能
  - デフォルト値：10個
  - 範囲：1～100個
  - 最適化実行時に入力値を読み込んで使用
- **対象ファイル**: `index.html`, `app.js`
- **コード変更**: `performOptimization()` で `max-menus-input` の値を取得して `selectMenusByGreedy()` に渡す
- **効果**: メニューが少ない日付でも、全メニューを対象に最適化できるようになった

### 27. 栄養グラフを常に五角形で表示 ✅
- **変更内容**:
  - グラフの栄養項目を常に5個（E, P, F, C, V）に固定
  - 選択されていない栄養項目も0で表示されるため、常に五角形になる
  - 目標値は点のみで表示（線と背景を削除）
  - 実績値は従来通り（塗りつぶし＋線）
- **対象ファイル**: `app.js` の `displayNutritionComparison()` と `drawRadarChart()`
- **効果**: グラフの形状が安定し、5項目を常に比較できるように改善

### 28. 結果画面のセクションタイトル削除 ✅
- **削除した要素**:
  - 「📌 固定メニュー」タイトル
  - 「✅ 提案メニュー」タイトル
- **理由**: メニューの色（青枠=固定、緑枠=提案）で判別できるため、テキストは不要
- **対象ファイル**: `index.html`
- **効果**: 結果表示がシンプル化、画面スペースを有効活用

---

## 🔍 未解決・確認待ち項目

### 1. メニュー10個制限の原因（ステータス：原因判明・サイト側の制限）
- **調査結果**:
  - スクレイパー実行ログより、「展開開始」時点で既に 10 メニューしか取得されていない
  - 展開ボタンをクリックしても +0（追加メニューなし）
  - 原因：Kyowaメニューサイト側で「今週」の日付は 10 メニューまでしか表示されない（仕様）
  - 1/13に 41 メニューが取得できた理由：「来週」のメニューも含まれていた可能性
- **結論**: サイト側の表示制限であり、スクレイパーのバグではない
- **対応策**:
  1. スクレイパーを「来週」タブにも対応させる（将来の改善）
  2. ユーザーへ「サイト側は最大10メニュー/日の制限」と説明する
  3. 「最大メニュー数」入力欄により、ユーザーが 1～10 の範囲内で調整可能
- **対象ファイル**: `src/scraper/fetchMenus.js`（将来改善時）

### 2. iPhone での実装確認
- **確認項目**:
  - ⏳ マウスオーバー削除後の色遷移（推奨→固定→除外）
  - ⏳ 凡例のラベル表示確認
  - ⏳ 最大メニュー数入力欄の動作
  - ⏳ グラフの常時五角形表示
  - ⏳ セクションタイトル削除後のレイアウト

### 10. メニュー色の統一修正
- **問題**: 枠（左端の線）の色と背景色が合致していない（水色線にオレンジ背景など）
- **解決**: 色を統一
  - **推奨（デフォルト）**: 緑枠 + 緑系統背景 (`#e6f7f0`)
  - **固定**: 青枠 + 青系統背景 (`#e6f3ff`)
  - **除外**: 赤枠 + 赤系統背景 (`#ffe6e6`)
- **ファイル**: `style.css`

### 11. メニュー選択の説明欄（凡例）の修正
- **変更内容**:
  - 古い「⭕️/➕/❌」記号を廃止
  - 色付きボックスで状態を表示
  - 各栄養成分（P, F, C, V）のラベルを凡例に追加
  - 凡例の背景を青系統に統一
- **ファイル**: `index.html`, `style.css`

### 12. メニュー栄養表示の順序と表示方法の改善
- **表示順**: E、P、F、C、V（エネルギーを追加）
- **ラベル廃止**: メニュー内の「P」「F」などの文字ラベルを削除（数値のみ表示）
- **小数点**: 1桁を保持（四捨五入なし）
- **等間隔表示**: グリッドレイアウト（5列）で等間隔に配置
  - メニューごとにズレがない統一的な表示を実現
- **ファイル**: `app.js`, `style.css`

### 13. 栄養目標の表示レイアウト改善
- **スペース削除**: 頭文字（E, P, F, C, V）の直後のスペースを削除
  - `E nergy` → `Energy`
- **表示順の変更**: `Energy テキストボックス kcal` の順に統一
  - グリッドレイアウト: `grid-template-columns: auto 1fr auto`
  - 見た目がシャープになり、操作性向上
- **ファイル**: `index.html`, `style.css`

---

## 🔧 追加で必要な修正項目

### 🔴 優先度: 高

#### 1. メニューの価格取得（スクレイパー対応）
- **現状**: 価格が取得できていない（スクレイパーが栄養情報のみ取得）
- **必要な情報**:
  - Kyowa メニューサイト（`https://kyowa2407225.uguide.info`）で価格が表示されている DOM 要素
  - 価格の HTML クラス名 or ID
  - 価格の位置（例：メニュー名の下、右側など）
- **対象ファイル**: `src/scraper/fetchMenus.js`
- **実装手順**:
  1. 価格の DOM セレクタを特定
  2. `scrapeMenus()` 関数内で価格を取得
  3. `nutrition` オブジェクトに `価格` キーを追加
  4. 再スクレイプ実行（`node prescrap.js`）

#### 2. 栄養目標の頭文字色の統一
- **現状**: 栄養目標の頭文字（E, P, F, C, V）が青系統のみ
- **要求**: メニュー表示の P, F, C, V と同じ色系統を使用
  - **E**: グレー系統 (`#95a5a6`)
  - **P**: 赤系統 (`#e74c3c`)
  - **F**: 黄色系統 (`#f39c12`)
  - **C**: 青系統 (`#3498db`)
  - **V**: 緑系統 (`#27ae60`)
- **対象ファイル**: `style.css`
- **実装**: `.nutrition-label` に個別のクラスを追加（`.nutrition-label-p`, `.nutrition-label-f` など）
- **ステータス**: ✅ 部分実装完了（HTML レイアウト整備まで）

#### 3. 栄養成分色の黒文字化（検討中）
- **質問**: P, F, C, V の背景色について
  - **オプション A**: 白文字のまま（現在）
  - **オプション B**: 明度を上げて黒文字に
- **推奨**: ユーザーの視認性テスト後に決定

### 🟡 優先度: 中

#### 3. 結果表示の改善
##### 3-1. 合計価格と栄養合計の表示
- **表示位置**: 「合計メニュー数」と「距離スコア」の下
- **表示内容**:
  - 合計価格（円表記）
  - 選択された栄養目標の合計値
  - 選択された栄養はハイライト表示
- **対象ファイル**: `app.js`, `index.html`, `style.css`

##### 3-2. 固定メニューと提案メニューの統合表示
- **現状**: 固定メニューと提案メニューが別セクション
- **要求**: 色で判別できるため、1つのリストに統合
  - 青枠 = 固定メニュー
  - 緑枠 = 提案メニュー
- **対象ファイル**: `index.html`, `app.js`

##### 3-3. グラフ表示の確認
- **現状**: Chart.js が読み込まれている
- **要確認**: グラフが正しく表示されるか
- **対象ファイル**: `app.js` の `displayNutritionComparison()`

### 🟢 優先度: 低

#### 4. スクロール最適化
- **問題**: メニュー一覧のスクロールが二重になっている可能性
- **確認事項**:
  - `.menus-list-container` の `max-height: 500px` が適切か
  - `-webkit-overflow-scrolling: touch` の動作確認
- **対象ファイル**: `style.css`

#### 5. アクセシビリティ改善
- **確認事項**:
  - 色覚異常者への配慮（P, F, C, V の色選択）
  - スクリーンリーダー対応（ARIA ラベル）
  - コントラスト比の確認

---

## ❓ 確認待ち項目

### 1. P, F, C, V の色選択（ユーザーの視認性テスト）
**質問**: メニューの P, F, C, V について、以下のどちらが見やすいですか？
- **オプション A**: 白文字のまま（現在の設定）
  - P: 赤背景 (`#e74c3c`) + 白文字
  - F: 黄色背景 (`#f39c12`) + 白文字
  - C: 青背景 (`#3498db`) + 白文字
  - V: 緑背景 (`#27ae60`) + 白文字
  
- **オプション B**: 明度を上げて黒文字に
  - P: 明るい赤背景 + 黒文字
  - F: 明るい黄色背景 + 黒文字
  - C: 明るい青背景 + 黒文字
  - V: 明るい緑背景 + 黒文字

**推奨**: iPhone でご確認いただき、見やすい方をお選びください

### 2. 価格取得の DOM 構造
**質問**: Kyowa メニューサイトで価格はどこに表示されていますか？
- ブラウザの開発者ツールで確認していただくか
- スクリーンショットを共有していただけると助かります

### 3. デプロイ確認
**GitHub Pages URL**: https://1onotakanori-art.github.io/kyowa-menu-optimizer/

**確認項目（第2弾）**:
- ✅ メニュー色の統一（枠色と背景色が合致）
- ✅ 栄養表示順が E, P, F, C, V に変更
- ✅ 栄養目標のスペース削除
- ✅ メニュー栄養表示が等間隔に配置
- ✅ 凡例が色で示されている
- ❓ P, F, C, V の色（白文字 vs 黒文字どちらが見やすいか）

---

## 📝 実装メモ

### メニュー状態の循環
```
推奨（緑枠・デフォルト） 
  ↓ タップ
固定（青枠）
  ↓ タップ
除外（赤枠）
  ↓ タップ
推奨（緑枠）に戻る
```

### 栄養成分の色定義
```css
.nutrition-p { background-color: #e74c3c; } /* 赤系統 */
.nutrition-f { background-color: #f39c12; } /* 黄色系統 */
.nutrition-c { background-color: #3498db; } /* 青系統 */
.nutrition-v { background-color: #27ae60; } /* 緑系統 */
```

### 変更されたファイル一覧
- `index.html` - 栄養目標の HTML 構造、ボタン配置
- `style.css` - 栄養目標のレイアウト、メニュー表示スタイル
- `app.js` - メニュー表示ロジック、状態管理、結果表示

---

## 🚀 次のステップ

1. **価格取得の実装**: DOM 構造を確認してスクレイパーを修正
2. **デプロイ確認**: iPhone で動作確認
3. **結果表示の改善**: 合計価格・栄養合計の表示
4. **色の統一**: 栄養目標の頭文字色をメニュー表示と合わせる

---

## 🔧 追加修正（2026/01/18）

### 🎯 目的
- **手動集計（固定のみ）**: ユーザーが「固定」にしたメニューだけで、栄養合計を即時表示できるようにする
- **状態UIの見直し**: 推奨/固定/除外の操作を直感的にし、誤操作（意図しない固定・除外）を減らす

### ✅ 仕様決定（ユーザー合意）
- **手動集計の対象**: 「固定」のみを集計（確定している値のみ）
- **固定は必ず集計に入れる**

### ✅ 追加の仕様決定（ユーザー合意）
- **推奨/除外の切替**: メニュー枠（行）タップで推奨↔除外
- **固定**: 固定スイッチ（iOSトグル風）の ON/OFF
  - 固定 ON: 除外を自動解除
  - 固定 ON の状態でメニュー枠タップ: 固定解除 → 除外へ切替
- **固定のみ合計の表示**: スクロールしても見える位置（上部/下部の固定表示）

### 🧩 UI/UX 方針（案）
- メニュータブ上部に「固定のみ集計サマリー」を常時表示
- 最適化ボタンは別動作（固定を制約として使う/使わないを明示）にして、手動集計と混同しない

---

## ✅ 実装計画（残タスク）

### STEP 1: 固定バーのUIを整える（ズレ/色/密度）
- 固定のみ合計のヒント文「メニューを『固定』にすると…」は削除（表示のズレがストレスのため）
- ヒントの表示/非表示でレイアウトが動かないようにする（高さを固定する・常に同じ要素構造にする等）
- 上部固定欄の背景色を **半透明で統一**（ボタンや固定のみ合計枠の内部は透明にしない）

### STEP 2: 固定バー内のボタン配置を改善
- ボタン文言を短縮
  - 「最適化を実行」→「最適化」
  - 「最適化なしで結果表示（固定のみ）」→「結果表示」
- 2つのボタンを **同じ行に横並び**、サイズは **均等（50/50）**

### STEP 3: 最適化との接続（混同防止）
- 最適化実行時に固定の扱いを明示（固定を制約として使う/使わない）
- 手動（固定のみ結果表示）と最適化結果の表現を揃える

---

## ✅ 実装ログ（2026/01/18 追記）

### 完了
- 固定スイッチ（iOSトグル風）のクリックが行タップに負けて動かない問題を修正（伝播停止の追加）
- 「固定のみ合計」を上部固定表示にして、スクロールしても常に確認できるように変更
- 最適化ボタンも上部固定バーに入れて、常に押せるように変更
- 「最適化なしで結果表示（固定のみ）」ボタンを追加
- 結果タブのメニュー表示をメニュータブに寄せるため、提案メニューの除外操作を ✕ ボタンから「行タップで除外トグル」に変更し、状態ラベル表示を追加

### 残タスク（確認しながら微調整）
- 上部固定バー（ボタン+合計）の高さが大きすぎないか（iPhoneで圧迫しないか）
- 固定バー背景の半透明を見やすく調整（背景の上に内容が来ても読めるか）
- 最適化実行時の「固定を制約として使う/使わない」のUIをどう出すか

